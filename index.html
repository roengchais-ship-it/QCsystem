<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC System v6.3 (Secure Login)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        /* --- THEME CONFIG --- */
        :root {
            --primary: #2c4b46;
            --primary-soft: #3d6e66;
            --active-green: #27ae60;
            --bg-body: #f0f2f5;
            --text-main: #2d3436;
            --text-light: #636e72;
            --border-input: #e0e0e0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(44, 75, 70, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.5; overflow-x: hidden; }

        /* --- Login Overlay --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, #1a2a28 100%);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 90%; max-width: 400px; text-align: center; animation: fadeInDown 0.5s ease-out;
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .login-card h2 { margin-bottom: 10px; color: var(--primary); font-size: 1.8rem; }
        .login-card p { color: #888; margin-bottom: 25px; font-size: 0.9rem; }
        .login-card input {
            width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 12px; font-family: 'Prompt'; font-size: 1rem; transition: 0.3s;
        }
        .login-card input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(44, 75, 70, 0.1); }
        #loginError { color: #e74c3c; font-size: 0.85rem; margin-bottom: 15px; display: none; }

        /* --- Main UI Hidden --- */
        #main-app { display: none; }
        .container { max-width: 1200px; margin: 0 auto; width: 100%; padding: 15px; }

        /* Loading */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; backdrop-filter: blur(5px); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header & Nav */
        .header { background: linear-gradient(120deg, var(--primary) 0%, var(--primary-soft) 100%); color: white; padding: 30px 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow-md); position: relative; }
        .user-panel { position: absolute; top: 15px; right: 20px; display: flex; align-items: center; gap: 10px; }
        .user-tag { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }

        .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 10px; background: white; border: none; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: var(--text-light); transition: 0.2s; box-shadow: var(--shadow-sm); font-family: 'Prompt'; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab.active { background: var(--active-green); color: white; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4); }

        .tab-content { display: none; background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-md); min-height: 450px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .form-section { margin-bottom: 30px; padding: 20px; border-radius: 12px; background: #fcfcfc; border: 1px solid #f0f0f0; }
        .section-title { font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid rgba(44, 75, 70, 0.1); padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { position: relative; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-input); border-radius: 10px; font-family: 'Prompt'; font-size: 0.95rem; }
        .required { color: #e74c3c; }

        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-family: 'Prompt'; font-weight: 500; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-secondary { background: #636e72; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; }

        /* Autocomplete */
        .autocomplete-list { position: absolute; z-index: 1000; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 10px; box-shadow: var(--shadow-md); max-height: 200px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f5f5f5; font-size: 0.9rem; }
        .autocomplete-item:hover { background: #f0f7f6; color: var(--primary); }

        /* Tables */
        .table-wrapper { overflow-x: auto; margin-top: 15px; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 0.85rem; color: #666; font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; font-size: 0.9rem; }

        /* Status */
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .pass { background: rgba(39, 174, 96, 0.1); color: #27ae60; }
        .fail { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .pending { background: rgba(243, 156, 18, 0.1); color: #f39c12; }

        /* Dashboard */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid var(--primary); }
        .kpi-val { font-size: 1.8rem; font-weight: 700; }
        .kpi-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: var(--shadow-md); }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; border: none; background: none; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .tabs { grid-template-columns: repeat(2, 1fr); }
            .user-panel { position: static; margin-top: 15px; justify-content: flex-start; }
            .header { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- üîê Login Overlay -->
    <div id="login-overlay">
        <div class="login-card">
            <h2>üîê QC System Login</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° id="loginForm" ‡πÅ‡∏•‡∏∞ onsubmit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Enter -->
            <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
                <input type="text" id="loginUser" placeholder="Username" autocomplete="username">
                <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password">
                <div id="loginError">Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                <button type="submit" class="btn btn-primary" style="width:100%; padding: 14px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </form>
        </div>
    </div>

    <!-- üîÑ Loading -->
    <div id="loading-overlay"><div class="spinner"></div><span id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span></div>

    <!-- üì± Main App -->
    <div id="main-app">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-panel">
                    <span class="user-tag" id="displayUser">User: -</span>
                    <button class="btn btn-warning btn-sm" onclick="openModal('passModal')">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
                    <button class="btn btn-danger btn-sm" onclick="handleLogout()">üö™ Logout</button>
                </div>
                <h1>‚òÅÔ∏è QC System v6.3</h1>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Secure Edition)</p>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('form')"><span>üìù</span> Form</button>
                <button class="tab" onclick="showTab('master')"><span>üìä</span> History</button>
                <button class="tab" onclick="showTab('summary')"><span>üìà</span> Dash</button>
                <button class="tab" onclick="showTab('search')"><span>üîç</span> Search</button>
            </div>

            <!-- Tab: Form -->
            <div id="form" class="tab-content active">
                <form id="qcForm">
                    <div class="form-section">
                        <div class="section-title">üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (RM Data)</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>RM Code <span class="required">*</span></label>
                                <input type="text" name="rmCode" id="rmCode" onkeyup="handleAutocomplete(event, 'rmCode')" required>
                                <div class="autocomplete-list" id="rmCode-autocomplete-list"></div>
                            </div>
                            <div class="form-group">
                                <label>RM Name <span class="required">*</span></label>
                                <input type="text" name="rmName" id="rmName" onkeyup="handleAutocomplete(event, 'rmName')" required>
                                <div class="autocomplete-list" id="rmName-autocomplete-list"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Supplier</label><input type="text" name="supplier" required></div>
                            <div class="form-group"><label>Lot No.</label><input type="text" name="lotNo" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Received Date</label><input type="date" name="receivedDate" required></div>
                            <div class="form-group"><label>Internal Lot</label><input type="text" name="internalLotNo"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">üß™ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (QC Result)</div>
                        <div class="form-row">
                            <div class="form-group"><label>Color</label><input type="text" name="qcColor" required></div>
                            <div class="form-group"><label>Odor</label><input type="text" name="qcOdor" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>pH</label><input type="text" name="qcPh"></div>
                            <div class="form-group"><label>Temp</label><input type="text" name="qcTemp"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Result <span class="required">*</span></label>
                                <select name="passFail" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                    <option value="Pass">‚úÖ Pass</option>
                                    <option value="Fail">‚ùå Fail</option>
                                    <option value="Pending">‚è≥ Pending</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Approved By</label><input type="text" name="approvedBy" required></div>
                        </div>
                        <div class="form-group"><label>Approved Date</label><input type="date" name="approvedDate" required></div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width:100%; padding:15px; font-size:1.1rem;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
            </div>

            <!-- Tab: Master -->
            <div id="master" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <h2>Inspection History</h2>
                    <div>
                        <button class="btn btn-success" onclick="exportToExcel()">üì• Excel</button>
                        <button class="btn btn-secondary" onclick="fetchData()">üîÑ Refresh</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>RM Code</th><th>Lot No.</th><th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th><th>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="masterTableBody">
                            <tr><td colspan="6" style="text-align:center; padding:40px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Dashboard -->
            <div id="summary" class="tab-content">
                <div class="kpi-grid">
                    <div class="kpi-card"><div><div class="kpi-label">Total</div><div class="kpi-val" id="dashTotal">0</div></div><div style="font-size:2rem;">üì¶</div></div>
                    <div class="kpi-card" style="border-left-color:#27ae60;"><div><div class="kpi-label">Pass</div><div class="kpi-val" id="dashPass">0</div></div><div style="font-size:2rem;">‚úÖ</div></div>
                    <div class="kpi-card" style="border-left-color:#e74c3c;"><div><div class="kpi-label">Fail</div><div class="kpi-val" id="dashFail">0</div></div><div style="font-size:2rem;">‚ùå</div></div>
                    <div class="kpi-card" style="border-left-color:#f39c12;"><div><div class="kpi-label">Pending</div><div class="kpi-val" id="dashPending">0</div></div><div style="font-size:2rem;">‚è≥</div></div>
                </div>
                <div style="background:#fff; padding:20px; border-radius:16px; box-shadow:var(--shadow-sm); max-width:500px; margin:auto;">
                    <h3 style="text-align:center; margin-bottom:20px;">QC Result Distribution</h3>
                    <canvas id="qcPieChart"></canvas>
                </div>
            </div>

            <!-- Tab: Search -->
            <div id="search" class="tab-content">
                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ RM Code, Name, ‡∏´‡∏£‡∏∑‡∏≠ Lot..." style="width:100%; padding:15px; border-radius:30px; border:2px solid #eee; margin-bottom:25px;" oninput="performSearch()">
                <div id="searchResults" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;"></div>
            </div>
        </div>
    </div>

    <!-- üîë Change Pass Modal -->
    <div id="passModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('passModal')">&times;</button>
            <h3>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
            <p style="font-size:0.8rem; color:#888; margin-bottom:20px;">Username: <span id="userToChange">-</span></p>
            <div class="form-group" style="margin-bottom:15px;">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label>
                <input type="password" id="oldPass">
            </div>
            <div class="form-group" style="margin-bottom:15px;">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                <input type="password" id="newPass">
            </div>
            <div class="form-group" style="margin-bottom:20px;">
                <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                <input type="password" id="confirmPass">
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="handleChangePassword()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <!-- ‚úèÔ∏è Edit Record Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-btn" onclick="closeModal('editModal')">&times;</button>
            <h3 style="margin-bottom:20px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
            <form id="editForm">
                <input type="hidden" id="editOriginalTimestamp">
                <div class="form-row">
                    <div class="form-group"><label>RM Code</label><input type="text" id="edit_rmCode" required></div>
                    <div class="form-group"><label>Lot No.</label><input type="text" id="edit_lotNo" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Result</label>
                        <select id="edit_passFail" required>
                            <option value="Pass">Pass</option><option value="Fail">Fail</option><option value="Pending">Pending</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Approved By</label><input type="text" id="edit_approvedBy" required></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
        </div>
    </div>

    <script>
        // --- ‚öôÔ∏è CONFIG ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwdpL4fbmZg3lrLR2XCpCMqrU7Ee_893AEuD_3Oc8Qi6q7bC0m0FIZQ3rEV3TJ3zKufAQ/exec";
        
        const MASTER_LIST = [
            { code: "RM1-SV-WT", name: "Water" },
            { code: "RM2-CA-LRGS", name: "Plantacare 1200 UP" },
            { code: "RM2-CA-DG-DGS", name: "Plantacare 2000 UP" },
            { code: "RM2-HT-ABLE", name: "Aloe vera extract" },
            { code: "RM2-HT-GCR", name: "Glycerine 99.7%" }
        ];

        // --- üîê AUTH LOGIC ---
        let currentUser = null;

        // Init passwords in LocalStorage (Simulation)
        if (!localStorage.getItem('qc_users')) {
            localStorage.setItem('qc_users', JSON.stringify({
                'qc': '1234',
                'admin': '1234'
            }));
        }

        function handleLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const users = JSON.parse(localStorage.getItem('qc_users'));

            if (users[u] && users[u] === p) {
                currentUser = u;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('displayUser').textContent = "User: " + u;
                document.getElementById('userToChange').textContent = u;
                document.getElementById('loginError').style.display = 'none';
                fetchData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
        }

        function handleChangePassword() {
            const oldP = document.getElementById('oldPass').value;
            const newP = document.getElementById('newPass').value;
            const confP = document.getElementById('confirmPass').value;
            const users = JSON.parse(localStorage.getItem('qc_users'));

            if (users[currentUser] !== oldP) { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
            if (newP !== confP) { alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô"); return; }
            if (newP.length < 4) { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"); return; }

            users[currentUser] = newP;
            localStorage.setItem('qc_users', JSON.stringify(users));
            alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            closeModal('passModal');
            document.getElementById('oldPass').value = '';
            document.getElementById('newPass').value = '';
            document.getElementById('confirmPass').value = '';
        }

        // --- üìä DATA LOGIC ---
        let inspections = [];
        let myPieChart = null;

        async function fetchData() {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...");
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                inspections = data.reverse();
                renderMasterTable();
                renderSummary();
            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            }
            showLoading(false);
        }

        document.getElementById('qcForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const fd = new FormData(this);
            const data = {
                action: 'insert',
                timestamp: new Date().toLocaleString('th-TH'),
                rmCode: fd.get('rmCode'),
                rmName: fd.get('rmName'),
                lotNo: fd.get('lotNo'),
                receivedDate: fd.get('receivedDate'),
                qcColor: fd.get('qcColor'),
                qcOdor: fd.get('qcOdor'),
                passFail: fd.get('passFail'),
                approvedBy: fd.get('approvedBy'),
                approvedDate: fd.get('approvedDate')
            };

            try {
                await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(data) });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                this.reset();
                fetchData();
            } catch (err) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
            showLoading(false);
        });

        // --- üñ•Ô∏è UI RENDER ---
        function renderMasterTable() {
            const tbody = document.getElementById('masterTableBody');
            if (inspections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }
            tbody.innerHTML = inspections.map((item, idx) => `
                <tr>
                    <td>${item.receivedDate}</td>
                    <td><strong>${item.rmCode}</strong></td>
                    <td>${item.lotNo}</td>
                    <td><span class="status-badge ${item.passFail.toLowerCase()}">${item.passFail}</span></td>
                    <td>${item.approvedBy}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openEditRecord(${idx})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRecord('${item.timestamp}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderSummary() {
            const total = inspections.length;
            const pass = inspections.filter(i => i.passFail === 'Pass').length;
            const fail = inspections.filter(i => i.passFail === 'Fail').length;
            const pending = inspections.filter(i => i.passFail === 'Pending').length;

            document.getElementById('dashTotal').textContent = total;
            document.getElementById('dashPass').textContent = pass;
            document.getElementById('dashFail').textContent = fail;
            document.getElementById('dashPending').textContent = pending;

            if (myPieChart) myPieChart.destroy();
            const ctx = document.getElementById('qcPieChart').getContext('2d');
            myPieChart = new Chart(ctx, {
                type: 'doughnut',
                plugins: [ChartDataLabels],
                data: {
                    labels: ['Pass', 'Fail', 'Pending'],
                    datasets: [{
                        data: [pass, fail, pending],
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: { color: '#fff', font: { weight: 'bold' } }
                    }
                }
            });
        }

        function performSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const res = inspections.filter(i => 
                String(i.rmCode).toLowerCase().includes(q) || 
                String(i.rmName).toLowerCase().includes(q) || 
                String(i.lotNo).toLowerCase().includes(q)
            );
            
            const box = document.getElementById('searchResults');
            box.innerHTML = res.length === 0 ? '<p style="grid-column:1/-1; text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>' : res.map(i => `
                <div class="kpi-card" style="display:block; border-left-color: ${i.passFail === 'Pass' ? '#27ae60' : (i.passFail === 'Fail' ? '#e74c3c' : '#f39c12')}">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>${i.rmCode}</strong>
                        <span class="status-badge ${i.passFail.toLowerCase()}">${i.passFail}</span>
                    </div>
                    <div style="font-size:0.85rem; color:#666;">
                        <p>Lot: ${i.lotNo}</p>
                        <p>Date: ${i.receivedDate}</p>
                        <p>Approved: ${i.approvedBy}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- üõ†Ô∏è HELPERS ---
        function showTab(id) {
            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`.tab[onclick*="${id}"]`).classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showLoading(show, text) {
            const el = document.getElementById('loading-overlay');
            el.style.display = show ? 'flex' : 'none';
            if (text) document.getElementById('loading-text').textContent = text;
        }

        function handleAutocomplete(e, field) {
            const list = document.getElementById(field + '-autocomplete-list');
            const val = e.target.value.toLowerCase();
            if (val.length < 1) { list.style.display = 'none'; return; }
            const matches = MASTER_LIST.filter(i => i.code.toLowerCase().includes(val) || i.name.toLowerCase().includes(val)).slice(0, 5);
            list.innerHTML = matches.map(m => `<div class="autocomplete-item" onclick="selectRM('${m.code}', '${m.name}')">${m.code} - ${m.name}</div>`).join('');
            list.style.display = matches.length ? 'block' : 'none';
        }

        function selectRM(c, n) {
            document.getElementById('rmCode').value = c;
            document.getElementById('rmName').value = n;
            document.querySelectorAll('.autocomplete-list').forEach(l => l.style.display = 'none');
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(inspections);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "QC_History");
            XLSX.writeFile(wb, "QC_Report.xlsx");
        }

        async function deleteRecord(ts) {
            if (!confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            try {
                await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', timestamp: ts }) });
                alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                fetchData();
            } catch (e) { alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
            showLoading(false);
        }

        function openEditRecord(idx) {
            const i = inspections[idx];
            document.getElementById('editOriginalTimestamp').value = i.timestamp;
            document.getElementById('edit_rmCode').value = i.rmCode;
            document.getElementById('edit_lotNo').value = i.lotNo;
            document.getElementById('edit_passFail').value = i.passFail;
            document.getElementById('edit_approvedBy').value = i.approvedBy;
            openModal('editModal');
        }

        document.getElementById('editForm').onsubmit = async function(e) {
            e.preventDefault();
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...");
            const data = {
                action: 'edit',
                originalTimestamp: document.getElementById('editOriginalTimestamp').value,
                rmCode: document.getElementById('edit_rmCode').value,
                lotNo: document.getElementById('edit_lotNo').value,
                passFail: document.getElementById('edit_passFail').value,
                approvedBy: document.getElementById('edit_approvedBy').value
            };
            try {
                await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(data) });
                closeModal('editModal');
                fetchData();
            } catch (err) { alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
            showLoading(false);
        };

        // Close dropdowns on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('.form-group')) {
                document.querySelectorAll('.autocomplete-list').forEach(l => l.style.display = 'none');
            }
        });

    </script>
</body>
</html>
