<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC System v5.0 (Final Perfected)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        /* --- THEME CONFIG --- */
        :root {
            --primary: #2c4b46;       /* Deep Teal */
            --primary-soft: #3d6e66;
            --active-green: #27ae60;  /* ‚úÖ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Active */
            --bg-body: #f0f2f5;
            --text-main: #2d3436;
            --text-light: #636e72;
            --border-input: #e0e0e0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(44, 75, 70, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Prompt', sans-serif; 
            background: var(--bg-body); 
            padding: 15px;
            color: var(--text-main); 
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .container { max-width: 1200px; margin: 0 auto; width: 100%; }

        /* Loading */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; backdrop-filter: blur(5px); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header */
        .header { 
            background: linear-gradient(120deg, var(--primary) 0%, var(--primary-soft) 100%); 
            color: white; padding: 25px 20px; border-radius: 16px; margin-bottom: 20px; 
            box-shadow: var(--shadow-md); position: relative; overflow: hidden;
        }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; font-weight: 600; }
        .header p { font-size: 0.9rem; opacity: 0.9; }

        /* --- TABS (Fixed Logic) --- */
        .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .tab { 
            padding: 12px 10px; background: white; border: none; border-radius: 12px; cursor: pointer; 
            font-size: 0.9rem; font-weight: 600; color: var(--text-light); transition: all 0.2s ease; 
            box-shadow: var(--shadow-sm); font-family: 'Prompt', sans-serif; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .tab:hover { transform: translateY(-2px); color: var(--primary); }
        
        /* ‚úÖ Active State Style */
        .tab.active { 
            background: var(--active-green); 
            color: white; 
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4); 
            transform: translateY(-1px);
        }
        
        .tab-content { display: none; background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-md); min-height: 400px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Form Styling */
        .form-section { margin-bottom: 30px; padding: 20px; border-radius: 12px; background: #fcfcfc; border: 1px solid #f0f0f0; }
        .section-title { font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid rgba(44, 75, 70, 0.1); padding-bottom: 8px; }
        .section-icon { background: rgba(44, 75, 70, 0.1); color: var(--primary); width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.9rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { position: relative; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: var(--text-main); }
        .required { color: #e74c3c; margin-left: 2px; }
        .form-group input, .form-group select { 
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-input); border-radius: 10px; 
            font-size: 0.95rem; font-family: 'Prompt', sans-serif; transition: all 0.2s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(44, 75, 70, 0.15); }
        
        /* Autocomplete Fixed */
        .autocomplete-list { 
            position: absolute; z-index: 1000; top: 100%; left: 0; right: 0; 
            background: white; border: 1px solid #ddd; border-radius: 0 0 10px 10px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; 
        }
        .autocomplete-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
        .autocomplete-item:hover { background: #f0f7f6; color: var(--primary); }

        .file-upload { border: 2px dashed #cbd5e0; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .file-upload:hover { border-color: var(--primary); background: #f0f7f6; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-family: 'Prompt', sans-serif; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-secondary { background: #636e72; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; padding: 6px 10px; font-size: 0.85rem; }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; border-radius: 8px; }

        /* Table */
        .table-container { border-radius: 12px; overflow-x: auto; border: 1px solid #eee; margin-top: 15px; width: 100%; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f9fa; color: var(--text-light); padding: 12px 10px; text-align: left; font-weight: 600; font-size: 0.85rem; white-space: nowrap; }
        td { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; color: var(--text-main); font-size: 0.9rem; vertical-align: middle; }
        tr:hover { background-color: #fafafa; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 20px; border-radius: 14px; box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid transparent; }
        .kpi-info h3 { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; }
        .kpi-info .value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
        .kpi-icon { font-size: 2rem; opacity: 0.15; }
        .card-total { border-bottom-color: var(--primary); } .card-total .kpi-icon { color: var(--primary); }
        .card-pass { border-bottom-color: #27ae60; } .card-pass .kpi-icon { color: #27ae60; }
        .card-fail { border-bottom-color: #e74c3c; } .card-fail .kpi-icon { color: #e74c3c; }
        .card-rate { border-bottom-color: #f39c12; } .card-rate .kpi-icon { color: #f39c12; }

        .charts-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid #f5f5f5; width: 100%; overflow: hidden; }
        .chart-header { font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 15px; }

        /* Search */
        .search-hero { background: white; padding: 30px 20px; border-radius: 16px; text-align: center; border: 1px solid #eee; margin-bottom: 20px; }
        .search-input-modern { 
            width: 100%; max-width: 100%; padding: 14px 20px 14px 45px;
            font-size: 1rem; border: 2px solid #eee; border-radius: 50px; font-family: 'Prompt';
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%232c4b46" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 15px center;
        }
        .result-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--primary); box-shadow: var(--shadow-sm); }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; white-space: nowrap; }
        .pass { background: rgba(39, 174, 96, 0.15); color: #27ae60; }
        .fail { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
        .pending { background: rgba(241, 196, 15, 0.15); color: #d35400; }
        .hold { background: rgba(149, 165, 166, 0.2); color: #7f8c8d; }
        .no-file { background: rgba(231, 76, 60, 0.1); color: #c0392b; border: 1px solid #e74c3c; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; }

        @media (max-width: 768px) {
            .tabs { gap: 5px; }
            .tab { flex-direction: row; padding: 10px 5px; border-radius: 10px; font-size: 0.85rem; white-space: nowrap; }
            .tab span { font-size: 1.1rem; }
            .form-row { grid-template-columns: 1fr; gap: 12px; }
            .charts-row { grid-template-columns: 1fr; } 
            .dashboard-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .page-header-flex { flex-direction: column; align-items: flex-start; gap: 10px; }
            .page-header-actions { width: 100%; }
            .page-header-actions .btn { flex: 1; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div><span id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></div>

    <div class="container">
        <div class="header">
            <h1>‚òÅÔ∏è QC System v5.0</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Perfect Fit)</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('form')"><span>üìù</span> Form</button>
            <button class="tab" onclick="showTab('master')"><span>üìä</span> History</button>
            <button class="tab" onclick="showTab('summary')"><span>üìà</span> Dash</button>
            <button class="tab" onclick="showTab('search')"><span>üîç</span> Search</button>
        </div>

        <div id="form" class="tab-content active">
            <form id="qcForm">
                <div class="form-section">
                    <div class="section-title"><div class="section-icon">A</div> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Raw Material)</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>RM Code <span class="required">*</span></label>
                            <input type="text" name="rmCode" id="rmCode" onkeyup="handleAutocomplete(event, 'rmCode')" autocomplete="off" required>
                            <div class="autocomplete-list" id="rmCode-autocomplete-list"></div>
                        </div>
                        <div class="form-group">
                            <label>RM Name <span class="required">*</span></label>
                            <input type="text" name="rmName" id="rmName" onkeyup="handleAutocomplete(event, 'rmName')" autocomplete="off" required>
                            <div class="autocomplete-list" id="rmName-autocomplete-list"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Supplier <span class="required">*</span></label><input type="text" name="supplier" required></div>
                        <div class="form-group"><label>Lot No. <span class="required">*</span></label><input type="text" name="lotNo" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Internal Lot</label><input type="text" name="internalLotNo" required></div>
                        <div class="form-group"><label>Received Date <span class="required">*</span></label><input type="date" name="receivedDate" required></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title"><div class="section-icon">B</div> ‡∏ú‡∏•‡∏à‡∏≤‡∏Å COA & ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</div>
                    <div class="form-row">
                        <div class="form-group"><label>‡∏™‡∏µ (COA Color)</label><input type="text" name="coaColor"></div>
                        <div class="form-group"><label>‡∏Å‡∏•‡∏¥‡πà‡∏ô (COA Odor)</label><input type="text" name="coaOdor"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>‡∏Ñ‡πà‡∏≤ pH (COA)</label><input type="text" name="coaPh"></div>
                        <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (COA Temp)</label><input type="text" name="coaTemp"></div>
                    </div>
                    <div class="form-group" style="margin-top:15px;">
                        <label>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå COA</label>
                        <div class="file-upload" onclick="document.getElementById('coaFile').click()">
                            <input type="file" id="coaFile" accept=".pdf,.jpg,.jpeg,.png" style="display:none"> 
                            <span style="font-size:1.5rem;">üìé</span>
                            <span style="color:#666; font-size:0.9rem;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                            <div id="fileName" style="color:var(--primary); font-weight:600; font-size:0.85rem; margin-top:5px;"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title"><div class="section-icon">C</div> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Result)</div>
                    <div class="form-row">
                        <div class="form-group"><label>‡∏™‡∏µ (QC Color)</label><input type="text" name="qcColor" required></div>
                        <div class="form-group"><label>‡∏Å‡∏•‡∏¥‡πà‡∏ô (QC Odor)</label><input type="text" name="qcOdor" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>‡∏Ñ‡πà‡∏≤ pH (QC)</label><input type="text" name="qcPh" required></div>
                        <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (QC)</label><input type="text" name="qcTemp" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Result <span class="required">*</span></label>
                            <select name="passFail" required style="font-weight:600; color:var(--primary);">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                <option value="Pass">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô (Pass)</option>
                                <option value="Fail">‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (Fail)</option>
                                <option value="Pending">‚è≥ ‡∏£‡∏≠‡∏ú‡∏• (Pending)</option>
                                <option value="Hold">üîí ‡∏≠‡∏≤‡∏¢‡∏±‡∏î (Hold)</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Approved By <span class="required">*</span></label><input type="text" name="approvedBy" required></div>
                    </div>
                    <div class="form-group"><label>Date <span class="required">*</span></label><input type="date" name="approvedDate" required></div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="width:100%; padding:12px;">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> 
                </div>
            </form>
        </div>

        <div id="master" class="tab-content">
            <div class="page-header-flex">
                <h2 class="page-header-title">üìä Inspection History</h2>
                <div class="page-header-actions">
                    <button class="btn btn-success" onclick="exportToExcel()">üì• Excel</button>
                    <button class="btn btn-secondary" onclick="fetchData()">üîÑ Refresh</button>
                </div>
            </div>
            <div class="table-container">
                <table id="masterTable">
                    <thead>
                        <tr>
                            <th>Date</th><th>RM Code</th><th>Lot No.</th><th>Result</th><th>File</th><th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="masterTableBody">
                        <tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="summary" class="tab-content">
            <h2 class="page-header-title" style="margin-bottom:20px;">üìà Overview</h2>
            <div class="dashboard-grid">
                <div class="kpi-card card-total"><div class="kpi-info"><h3>Total</h3><div class="value" id="dashTotal">0</div></div><div class="kpi-icon">üì¶</div></div>
                <div class="kpi-card card-pass"><div class="kpi-info"><h3>Pass</h3><div class="value" id="dashPass">0</div></div><div class="kpi-icon">‚úÖ</div></div>
                <div class="kpi-card card-fail"><div class="kpi-info"><h3>Fail</h3><div class="value" id="dashFail">0</div></div><div class="kpi-icon">‚ùå</div></div>
                <div class="kpi-card card-rate"><div class="kpi-info"><h3>Rate</h3><div class="value" id="dashRate">0%</div></div><div class="kpi-icon">üìä</div></div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <div class="chart-header">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
                    <div style="height: 250px; position: relative;"><canvas id="qcPieChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-header">‚è≥ ‡∏£‡∏≠‡∏ú‡∏• (Pending / Hold / No COA)</div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;">
                            <thead>
                                <tr style="border-bottom:2px solid #eee;">
                                    <th style="background:white;">RM Code</th>
                                    <th style="background:white;">Status</th>
                                    <th style="background:white;">Aging</th>
                                </tr>
                            </thead>
                            <tbody id="dashPendingBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="search" class="tab-content">
            <h2 class="page-header-title" style="margin-bottom:20px;">üîç Advanced Search</h2>
            <div class="search-hero">
                <input type="text" id="searchInput" class="search-input-modern" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ RM Code, Name, Lot..." oninput="performSearch()">
            </div>
            <div id="searchResults"></div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h2 style="color:var(--primary); margin:0; font-size:1.2rem;">‚úèÔ∏è Edit</h2>
                <button class="close-modal" onclick="closeEditModal()" style="font-size:24px; border:none; background:none; cursor:pointer;">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editOriginalTimestamp">
                <div class="form-row">
                    <div class="form-group"><label>RM Code</label><input type="text" id="edit_rmCode" required></div>
                    <div class="form-group"><label>RM Name</label><input type="text" id="edit_rmName" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Supplier</label><input type="text" id="edit_supplier" required></div>
                    <div class="form-group"><label>Lot No.</label><input type="text" id="edit_lotNo" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Internal Lot</label><input type="text" id="edit_internalLotNo" required></div>
                    <div class="form-group"><label>Rec. Date</label><input type="date" id="edit_receivedDate" required></div>
                </div>
                
                <div style="background:#f0f7f6; padding:15px; border-radius:10px; margin:10px 0;">
                    <label style="font-weight:600; color:var(--primary);">COA Info</label>
                    <div class="form-row" style="margin-top:10px;">
                        <div class="form-group"><label>COA Color</label><input type="text" id="edit_coaColor"></div>
                        <div class="form-group"><label>COA Odor</label><input type="text" id="edit_coaOdor"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>COA pH</label><input type="text" id="edit_coaPh"></div>
                        <div class="form-group"><label>COA Temp</label><input type="text" id="edit_coaTemp"></div>
                    </div>
                </div>

                <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin:15px 0; border:1px solid #eee;">
                    <label style="font-weight:600; color:#333;">QC Results</label>
                    <div class="form-row" style="margin-top:10px;">
                        <div class="form-group"><label>QC Color</label><input type="text" id="edit_qcColor"></div>
                        <div class="form-group"><label>QC Odor</label><input type="text" id="edit_qcOdor"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>QC pH</label><input type="text" id="edit_qcPh"></div>
                        <div class="form-group"><label>QC Temp</label><input type="text" id="edit_qcTemp"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Result</label>
                        <select id="edit_passFail" required>
                            <option value="Pass">Pass</option><option value="Fail">Fail</option><option value="Pending">Pending</option><option value="Hold">Hold</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Approved By</label><input type="text" id="edit_approvedBy" required></div>
                </div>
                <div class="form-group"><label>Date</label><input type="date" id="edit_approvedDate" required></div>
                
                <div class="form-group" style="margin:15px 0;">
                    <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#f0f4ff; border-radius:8px;">
                        <span id="edit_fileStatus" style="font-weight:600; font-size:0.85rem; color:#555;">Checking...</span>
                        <button type="button" id="edit_btnRemoveFile" class="btn btn-danger btn-sm" onclick="markFileRemoved()" style="display:none;">‡∏•‡∏ö</button>
                    </div>
                    <input type="file" id="edit_fileInput" accept=".pdf,.jpg,.jpeg,.png" style="margin-top:10px; font-size:0.85rem;">
                </div>
                <div style="text-align: center; margin-top: 20px;"><button type="submit" class="btn btn-primary" style="width:100%;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // ‚öôÔ∏è URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        // ============================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyIrW6R8QPEkvxoO4p-cMIv3T3Eqcp2xIhI26kgReu6g42s2kYon1IBS2foAyd3TBROmA/exec"; 
        
        const MASTER_LIST = [
             { code: 'RM1-SV-WT', name: 'Water' }, { code: 'RM2-CA-LRGS', name: 'Plantacare 1200 UP' },
             { code: 'RM2-CA-DG-DGS', name: 'Plantacare 2000 UP' }, { code: 'RM2-SV-ETNS', name: 'Sciwis' },
             { code: 'RM2-CA-SCG', name: 'Galsoft SCG' }, { code: 'RM2-PT-RDFE', name: 'Koprafinol' }
        ];

        let inspections = [];
        let currentCoaFileData = null;
        let editCoaFileData = null;
        let isEditFileRemoved = false;
        let currentEditOriginalUrl = "";
        let myPieChart = null;

        async function fetchData() {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
            try {
                if(!WEB_APP_URL || WEB_APP_URL.includes("‡∏ß‡∏≤‡∏á_URL")) throw new Error("Invalid URL");
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                inspections = data.reverse();
                renderMasterTable();
                renderSummary();
                showLoading(false);
            } catch (error) { console.error(error); alert("Connection Error"); showLoading(false); }
        }

        document.getElementById('qcForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitData(new FormData(e.target), 'insert');
            e.target.reset();
            document.getElementById('fileName').textContent = "";
            currentCoaFileData = null;
        });

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitData(null, 'edit');
            closeEditModal();
        });

        async function submitData(formData, action) {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...");
            let data = {};
            if (action === 'insert') {
                data = {
                    action: 'insert',
                    timestamp: new Date().toLocaleString('th-TH'),
                    rmCode: formData.get('rmCode'), rmName: formData.get('rmName'), supplier: formData.get('supplier'),
                    lotNo: formData.get('lotNo'), internalLotNo: formData.get('internalLotNo'), receivedDate: formData.get('receivedDate'),
                    coaColor: formData.get('coaColor'), coaOdor: formData.get('coaOdor'), coaPh: formData.get('coaPh'), coaTemp: formData.get('coaTemp'),
                    qcColor: formData.get('qcColor'), qcOdor: formData.get('qcOdor'), qcPh: formData.get('qcPh'), qcTemp: formData.get('qcTemp'),
                    passFail: formData.get('passFail'), approvedBy: formData.get('approvedBy'), approvedDate: formData.get('approvedDate'),
                    coaFile: currentCoaFileData
                };
            } else {
                data = {
                    action: 'edit',
                    originalTimestamp: document.getElementById('editOriginalTimestamp').value,
                    rmCode: document.getElementById('edit_rmCode').value, rmName: document.getElementById('edit_rmName').value, supplier: document.getElementById('edit_supplier').value,
                    lotNo: document.getElementById('edit_lotNo').value, internalLotNo: document.getElementById('edit_internalLotNo').value, receivedDate: document.getElementById('edit_receivedDate').value,
                    coaColor: document.getElementById('edit_coaColor').value, coaOdor: document.getElementById('edit_coaOdor').value, coaPh: document.getElementById('edit_coaPh').value, coaTemp: document.getElementById('edit_coaTemp').value,
                    qcColor: document.getElementById('edit_qcColor').value, qcOdor: document.getElementById('edit_qcOdor').value, qcPh: document.getElementById('edit_qcPh').value, qcTemp: document.getElementById('edit_qcTemp').value,
                    passFail: document.getElementById('edit_passFail').value, approvedBy: document.getElementById('edit_approvedBy').value, approvedDate: document.getElementById('edit_approvedDate').value,
                    coaFile: editCoaFileData, isFileRemoved: isEditFileRemoved, originalFileUrl: currentEditOriginalUrl
                };
            }
            try {
                await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(data) });
                alert("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); fetchData();
            } catch (error) { console.warn(error); alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß"); fetchData(); } finally { showLoading(false); }
        }

        async function deleteRecord(index) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) return;
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...");
            try { await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', timestamp: inspections[index].timestamp }) }); alert("üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); fetchData(); } 
            catch (e) { console.warn(e); alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); fetchData(); } finally { showLoading(false); }
        }

        function renderMasterTable() {
            const tbody = document.getElementById('masterTableBody');
            if (inspections.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }
            tbody.innerHTML = inspections.map((item, index) => {
                let badgeClass = item.passFail === 'Pass' ? 'pass' : (item.passFail === 'Fail' ? 'fail' : (item.passFail === 'Hold' ? 'hold' : 'pending'));
                let rmDisplay = `<strong>${item.rmCode}</strong>`;
                return `<tr>
                    <td>${item.receivedDate}</td>
                    <td>${rmDisplay}<br><span style="font-size:0.75rem; color:#888;">${item.rmName}</span></td>
                    <td>${item.lotNo}</td>
                    <td><span class="status-badge ${badgeClass}">${item.passFail}</span></td>
                    <td>${item.coaFile && item.coaFile.isLink ? `<a href="${item.coaFile.data}" target="_blank" class="btn btn-info btn-sm" style="padding:4px 8px;">üìÑ</a>` : '-'}</td>
                    <td><div style="display:flex; gap:5px;"><button class="btn btn-warning btn-sm" onclick="openEditModal(${index})" style="padding:4px 8px;">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="deleteRecord(${index})" style="padding:4px 8px;">üóëÔ∏è</button></div></td>
                </tr>`;
            }).join('');
        }

        function renderSummary() {
            const total = inspections.length;
            const passed = inspections.filter(i => i.passFail === 'Pass').length;
            const failed = inspections.filter(i => i.passFail === 'Fail').length;
            const rate = total > 0 ? ((passed / total) * 100).toFixed(0) : 0;

            animateValue("dashTotal", 0, total, 1000); animateValue("dashPass", 0, passed, 1000); animateValue("dashFail", 0, failed, 1000);
            document.getElementById('dashRate').textContent = rate + '%';

            if (myPieChart) myPieChart.destroy();
            myPieChart = new Chart(document.getElementById('qcPieChart').getContext('2d'), {
                type: 'doughnut',
                plugins: [ChartDataLabels],
                data: { labels: ['Pass', 'Fail', 'Pending', 'Hold'], datasets: [{ data: [passed, failed, inspections.filter(i=>i.passFail==='Pending').length, inspections.filter(i=>i.passFail==='Hold').length], backgroundColor: ['#27ae60', '#e74c3c', '#f39c12', '#95a5a6'], borderWidth: 0 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, cutout: '65%', 
                    plugins: { 
                        legend: { position: 'bottom', labels: { font: { family: 'Prompt', size: 11 } } },
                        datalabels: { color: '#fff', font: { weight: 'bold', size: 12 }, formatter: (val, ctx) => val > 0 ? val : '' }
                    } 
                }
            });

            const pendingItems = inspections.filter(i => 
                i.passFail === 'Pending' || 
                i.passFail === 'Hold' || 
                (!i.coaFile || !i.coaFile.data) 
            );
            
            document.getElementById('dashPendingBody').innerHTML = pendingItems.length === 0 ? '<tr><td colspan="3" style="text-align:center; padding:15px; color:#999; font-size:0.9rem;">No pending items</td></tr>' : pendingItems.map(item => {
                const days = Math.floor((new Date() - new Date(item.receivedDate)) / (1000 * 60 * 60 * 24));
                let agingColor = days > 7 ? '#e74c3c' : (days > 3 ? '#f39c12' : '#27ae60');
                
                let statusBadge = '';
                if(item.passFail === 'Pending') statusBadge = '<span class="status-badge pending">Pending</span>';
                else if(item.passFail === 'Hold') statusBadge = '<span class="status-badge hold">Hold</span>';
                else if(!item.coaFile || !item.coaFile.data) statusBadge = '<span class="status-badge no-file">No COA</span>';

                return `<tr style="border-bottom:1px solid #f5f5f5;">
                    <td style="padding:10px; font-weight:600; font-size:0.85rem;">${item.rmCode}</td>
                    <td>${statusBadge}</td>
                    <td><span style="color:${agingColor}; font-weight:bold; font-size:0.85rem;">${days} ‡∏ß‡∏±‡∏ô</span></td>
                </tr>`;
            }).join('');
        }

        function performSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            const results = inspections.filter(item => String(item.rmCode).toLowerCase().includes(term) || String(item.rmName).toLowerCase().includes(term) || String(item.lotNo).toLowerCase().includes(term));
            document.getElementById('searchResults').innerHTML = results.map(item => `
                <div class="result-card" style="background:white; padding:15px; border-radius:12px; margin-bottom:10px; border-left:4px solid var(--primary); box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #f0f0f0; padding-bottom:5px;">
                        <h3 style="margin:0; font-size:1rem; color:var(--primary);">${item.rmCode}</h3>
                        <span class="status-badge ${item.passFail === 'Pass' ? 'pass' : (item.passFail === 'Fail' ? 'fail' : 'pending')}">${item.passFail}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; font-size:0.85rem;">
                        <div><label style="color:#999;">LOT</label> <b>${item.lotNo}</b></div>
                        <div><label style="color:#999;">QC</label> ${item.qcColor}</div>
                    </div>
                </div>`).join('');
        }

        function openEditModal(index) {
            const item = inspections[index];
            document.getElementById('editOriginalTimestamp').value = item.timestamp;
            ['rmCode','rmName','supplier','lotNo','internalLotNo','receivedDate','coaColor','coaOdor','coaPh','coaTemp','qcColor','qcOdor','qcPh','qcTemp','passFail','approvedBy','approvedDate'].forEach(id => {
                const el = document.getElementById('edit_'+id);
                if(el) el.value = item[id] || '';
            });
            editCoaFileData = null; isEditFileRemoved = false; document.getElementById('edit_fileInput').value = "";
            currentEditOriginalUrl = item.coaFile?.isLink ? item.coaFile.data : "";
            document.getElementById('edit_fileStatus').textContent = currentEditOriginalUrl ? "‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå" : "‡∏ß‡πà‡∏≤‡∏á";
            document.getElementById('edit_btnRemoveFile').style.display = currentEditOriginalUrl ? "inline-block" : "none";
            document.getElementById('editModal').classList.add('active');
        }
        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }
        function markFileRemoved() { isEditFileRemoved = true; document.getElementById('edit_fileStatus').textContent = "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß"; document.getElementById('edit_btnRemoveFile').style.display = "none"; }
        function animateValue(id, start, end, duration) { const obj = document.getElementById(id); let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerHTML = Math.floor(progress * (end - start) + start); if (progress < 1) window.requestAnimationFrame(step); else obj.innerHTML = end; }; window.requestAnimationFrame(step); }
        function exportToExcel() { const ws = XLSX.utils.json_to_sheet(inspections.map(i => ({...i, coaFile: i.coaFile?.data || '-'}))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "QC_Data"); XLSX.writeFile(wb, `QC_Report.xlsx`); }
        function readFile(input, callback) { const file = input.files[0]; if(file) { const reader = new FileReader(); reader.onload = e => callback({ name: file.name, data: e.target.result }); reader.readAsDataURL(file); } }
        document.getElementById('coaFile').addEventListener('change', e => readFile(e.target, d => { currentCoaFileData = d; document.getElementById('fileName').textContent = "üì¶ " + d.name; }));
        document.getElementById('edit_fileInput').addEventListener('change', e => readFile(e.target, d => { editCoaFileData = d; document.getElementById('edit_fileStatus').textContent = "‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà"; isEditFileRemoved = false; }));
        function showLoading(show, text) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; if(text) document.getElementById('loading-text').textContent = text; }
        
        // ‚úÖ Fixed showTab Logic
        function showTab(t) { 
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); 
            document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); 
            document.getElementById(t).classList.add('active'); 
            
            // Highlight the correct button
            const btn = document.querySelector(`.tab[onclick*="${t}"]`);
            if(btn) btn.classList.add('active');

            if(t==='master'||t==='summary') fetchData(); 
        }
        
        function handleAutocomplete(e, f) { 
            const listDiv = document.getElementById(f + '-autocomplete-list'); 
            const val = e.target.value.toLowerCase(); 
            if (val.length < 1) { listDiv.style.display = 'none'; return; } 
            const matches = MASTER_LIST.filter(i => i.code.toLowerCase().includes(val) || i.name.toLowerCase().includes(val)).slice(0, 5); 
            listDiv.innerHTML = matches.map(item => `<div class="autocomplete-item" onclick="selectRM('${item.code}', '${item.name}')">${item.code} - ${item.name}</div>`).join(''); 
            listDiv.style.display = matches.length ? 'block' : 'none'; 
        }
        function selectRM(code, name) { document.getElementById('rmCode').value = code; document.getElementById('rmName').value = name; document.querySelectorAll('.autocomplete-list').forEach(l => l.style.display = 'none'); }
        document.addEventListener('click', e => { if (!e.target.closest('.form-group')) document.querySelectorAll('.autocomplete-list').forEach(l => l.style.display = 'none'); });

        window.onload = fetchData;
    </script>
</body>
</html>
